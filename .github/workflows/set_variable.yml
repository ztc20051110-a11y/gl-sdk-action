on: 
  workflow_dispatch:
    inputs:
      device:
        description: 'Select device'     
        required: true
        type: choice
        options:
        - AX1800
        - AXT1800
        - MT2500
        - MT3000
        - SF1200
        - SFT1200
      sourcecode:
        description: 'Source code URL'     
        required: true
      pkgname:
        description: 'Openwrt package name'  
        required: true
      email:
        description: 'Git account email address'  
        required: false
      password:
        description: 'Git account password'  
        required: false
        
jobs:
  setpackage:
    runs-on: [self-hosted, windows, x64]
    steps:
    - name: Checkout
      uses: actions/checkout@master
      env:
        NODE_TLS_REJECT_UNAUTHORIZED: 0

    - name: Setup environment and debug
      run: |
        echo "=== Workspace Debug Info ==="
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
        cd "$GITHUB_WORKSPACE"
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "=== Build script check ==="
        if [ -f "./build.sh" ]; then
          echo "build.sh found, checking content..."
          head -20 ./build.sh
          chmod +x ./build.sh
        else
          echo "ERROR: build.sh not found!"
          exit 1
        fi

    - name: Build IPK with detailed logging
      id: build
      env:
        SOURCECODEURL: ${{ github.event.inputs.sourcecode }}
        PKGNAME: ${{ github.event.inputs.pkgname }}
        BOARD: ${{ github.event.inputs.device }}
        EMAIL: ${{ github.event.inputs.email }}
        PASSWORD: ${{ github.event.inputs.password }}
        GIT_SSL_NO_VERIFY: true
        NODE_TLS_REJECT_UNAUTHORIZED: 0
      run: |
        echo "=== Build Parameters ==="
        echo "Source Code: $SOURCECODEURL"
        echo "Package Name: $PKGNAME"
        echo "Device: $BOARD"
        
        cd "$GITHUB_WORKSPACE"
        echo "Starting build process..."
        
        # ‰ΩøÁî® tee ÂêåÊó∂ËæìÂá∫Âà∞ÊéßÂà∂Âè∞ÂíåÊñá‰ª∂ÔºåÂπ∂ÊçïËé∑ÈÄÄÂá∫Á†Å
        set -o pipefail
        ./build.sh 2>&1 | tee build_output.log
        BUILD_EXIT_CODE=$?
        
        echo "Build process finished with exit code: $BUILD_EXIT_CODE"
        
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "=== BUILD FAILED ==="
          echo "Last 30 lines of build output:"
          tail -30 build_output.log
          echo "=== Checking for common issues ==="
          # Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥
          df -h
          # Ê£ÄÊü•ÂÜÖÂ≠ò‰ΩøÁî®
          free -h || echo "free command not available"
        else
          echo "=== BUILD SUCCESS ==="
          echo "Checking for generated IPK files:"
          find . -name "*.ipk" -type f 2>/dev/null || echo "No IPK files found"
        fi
        
        # ‰øùÂ≠òÈÄÄÂá∫Á†Å‰æõÂêéÁª≠Ê≠•È™§‰ΩøÁî®
        echo "exit_code=$BUILD_EXIT_CODE" >> $GITHUB_OUTPUT
        exit $BUILD_EXIT_CODE

    - name: Upload build logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-failure-logs
        path: |
          ./build_output.log
        retention-days: 7

    - name: Upload IPK artifacts (on success)
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ github.event.inputs.pkgname }}_${{ github.event.inputs.device }}_ipks
        path: |
          ./*.ipk
          ./bin/packages/*/*/*.ipk
          ./bin/targets/*/*/packages/*.ipk
        retention-days: 30
      env:
        NODE_TLS_REJECT_UNAUTHORIZED: 0

    - name: Final status
      if: always()
      run: |
        echo "=== Workflow completed ==="
        echo "Build step exit code: ${{ steps.build.outputs.exit_code }}"
        if [ "${{ steps.build.outputs.exit_code }}" == "0" ]; then
          echo "üéâ Build completed successfully!"
        else
          echo "‚ùå Build failed with exit code ${{ steps.build.outputs.exit_code }}"
          echo "Check the build logs above for details."
        fi
